<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Blurry Dots</title>
  <style>
    :root {
      --sky-1: #0c1020;
      --sky-2: #1a2a44;
      --sky-3: #2a3f57;
      --mist-1: rgba(210, 230, 255, 0.8);
      --mist-2: rgba(180, 205, 235, 0.65);
      --mist-3: rgba(140, 170, 205, 0.5);
      --accent: #d8f1ff;
      --ink: #f4f7ff;
      --panel: rgba(10, 18, 32, 0.6);
      --panel-border: rgba(200, 220, 250, 0.18);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, "Segoe UI", sans-serif;
      min-height: 100vh;
      color: var(--ink);
      background: var(--sky-1);
      overflow: hidden;
    }

    #blurrydots {
      position: fixed;
      inset: 0;
      width: 100vw;
      height: 100vh;
      display: block;
    }

    .ui {
      position: relative;
      z-index: 2;
      display: flex;
      justify-content: flex-end;
      padding: 5vh 6vw;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--panel-border);
      border-radius: 18px;
      padding: 18px 18px 16px;
      backdrop-filter: blur(12px);
      display: grid;
      gap: 14px;
      box-shadow: 0 20px 40px rgba(5, 10, 20, 0.35);
    }

    .panel h2 {
      font-size: 1rem;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      font-weight: 500;
      color: rgba(240, 248, 255, 0.9);
    }

    .control {
      display: grid;
      gap: 8px;
    }

    .control label {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      letter-spacing: 0.05em;
      color: rgba(230, 240, 255, 0.7);
      text-transform: uppercase;
    }

    .control input[type="range"] {
      width: 100%;
      accent-color: var(--accent);
    }

    .control input[type="number"] {
      width: 100%;
      border: 1px solid rgba(220, 235, 255, 0.2);
      background: rgba(15, 25, 40, 0.7);
      color: var(--ink);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 0.9rem;
    }

    .control input[type="color"] {
      width: 100%;
      height: 38px;
      border: 1px solid rgba(220, 235, 255, 0.2);
      border-radius: 10px;
      background: rgba(15, 25, 40, 0.7);
      padding: 4px;
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    button {
      border: 1px solid rgba(220, 235, 255, 0.2);
      background: rgba(15, 25, 40, 0.7);
      color: var(--ink);
      border-radius: 999px;
      padding: 10px 14px;
      font-size: 0.85rem;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      cursor: pointer;
      transition: transform 0.2s ease, background 0.2s ease;
    }

    button:hover {
      transform: translateY(-1px);
      background: rgba(20, 35, 55, 0.8);
    }

    .hint {
      font-size: 0.8rem;
      letter-spacing: 0.05em;
      color: rgba(220, 235, 255, 0.55);
    }

    @media (max-width: 900px) {
      .ui {
        justify-content: flex-start;
      }

      .panel {
        max-width: 360px;
      }
    }
  </style>
</head>
<body>
  <canvas id="blurrydots"></canvas>
  <div class="ui">
    <div class="panel">
      <h2>Controls</h2>
      <div class="control">
        <label for="background">Background <span data-value="background"></span></label>
        <input id="background" type="color" value="#0c1020" />
      </div>
      <div class="control">
        <label for="blurrydotsColor">Blurry Dots Color <span data-value="blurrydotsColor"></span></label>
        <input id="blurrydotsColor" type="color" value="#d2e6ff" />
      </div>
      <div class="row">
        <div class="control">
          <label for="exportWidth">Export W <span data-value="exportWidth"></span></label>
          <input id="exportWidth" type="number" min="320" max="7680" value="2560" />
        </div>
        <div class="control">
          <label for="exportHeight">Export H <span data-value="exportHeight"></span></label>
          <input id="exportHeight" type="number" min="320" max="4320" value="1440" />
        </div>
      </div>
      <div class="control">
        <label for="density">Density <span data-value="density"></span></label>
        <input id="density" type="range" min="20" max="160" value="90" />
      </div>
      <div class="control">
        <label for="layers">Layers <span data-value="layers"></span></label>
        <input id="layers" type="range" min="1" max="5" value="3" />
      </div>
      <div class="control">
        <label for="size">Puff Size <span data-value="size"></span></label>
        <input id="size" type="range" min="40" max="220" value="140" />
      </div>
      <div class="control">
        <label for="blur">Blur <span data-value="blur"></span></label>
        <input id="blur" type="range" min="0" max="60" value="28" />
      </div>
      <div class="control">
        <label for="light">Light <span data-value="light"></span></label>
        <input id="light" type="range" min="0" max="100" value="35" />
      </div>
      <div class="row">
        <button id="randomize" type="button">New Seed</button>
        <button id="download" type="button">Download PNG</button>
      </div>
      <div class="hint">Der Download nutzt die Export-Groesse.</div>
    </div>
  </div>

  <script>
    const canvas = document.getElementById("blurrydots");
    const ctx = canvas.getContext("2d");
    const dpr = Math.min(window.devicePixelRatio || 1, 2);

    const inputs = {
      background: document.getElementById("background"),
      blurrydotsColor: document.getElementById("blurrydotsColor"),
      exportWidth: document.getElementById("exportWidth"),
      exportHeight: document.getElementById("exportHeight"),
      density: document.getElementById("density"),
      layers: document.getElementById("layers"),
      size: document.getElementById("size"),
      blur: document.getElementById("blur"),
      light: document.getElementById("light"),
    };

    const valueLabels = document.querySelectorAll("[data-value]");

    let noiseSeed = Math.random() * 1000;
    let layers = [];

    const params = {
      background: inputs.background.value,
      blurrydotsColor: inputs.blurrydotsColor.value,
      exportWidth: Number(inputs.exportWidth.value),
      exportHeight: Number(inputs.exportHeight.value),
      density: Number(inputs.density.value),
      layers: Number(inputs.layers.value),
      size: Number(inputs.size.value),
      blur: Number(inputs.blur.value),
      light: Number(inputs.light.value),
    };

    function hexToRgb(hex) {
      const clean = hex.replace("#", "");
      if (clean.length !== 6) {
        return { r: 210, g: 230, b: 255 };
      }
      const r = parseInt(clean.slice(0, 2), 16);
      const g = parseInt(clean.slice(2, 4), 16);
      const b = parseInt(clean.slice(4, 6), 16);
      return { r, g, b };
    }

    function rgbaFromHex(hex, alpha) {
      const { r, g, b } = hexToRgb(hex);
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function resize() {
      canvas.width = Math.floor(window.innerWidth * dpr);
      canvas.height = Math.floor(window.innerHeight * dpr);
      canvas.style.width = `${window.innerWidth}px`;
      canvas.style.height = `${window.innerHeight}px`;
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }

    function rand(min, max) {
      return min + Math.random() * (max - min);
    }

    function valueNoise(x, y) {
      const ix = Math.floor(x);
      const iy = Math.floor(y);
      const fx = x - ix;
      const fy = y - iy;

      function hash(nx, ny) {
        const s = Math.sin(nx * 12.9898 + ny * 78.233 + noiseSeed) * 43758.5453;
        return s - Math.floor(s);
      }

      const a = hash(ix, iy);
      const b = hash(ix + 1, iy);
      const c = hash(ix, iy + 1);
      const d = hash(ix + 1, iy + 1);

      const ux = fx * fx * (3 - 2 * fx);
      const uy = fy * fy * (3 - 2 * fy);

      return (
        a * (1 - ux) * (1 - uy) +
        b * ux * (1 - uy) +
        c * (1 - ux) * uy +
        d * ux * uy
      );
    }

    function drawBackdrop(targetCtx, width, height) {
      targetCtx.fillStyle = params.background;
      targetCtx.fillRect(0, 0, width, height);
      document.body.style.setProperty("--sky-1", params.background);
    }

    function initLayers(width, height) {
      layers = [];
      const baseColors = [
        rgbaFromHex(params.blurrydotsColor, 0.75),
        rgbaFromHex(params.blurrydotsColor, 0.62),
        rgbaFromHex(params.blurrydotsColor, 0.5),
        rgbaFromHex(params.blurrydotsColor, 0.42),
        rgbaFromHex(params.blurrydotsColor, 0.36),
      ];

      for (let i = 0; i < params.layers; i += 1) {
        const puffs = [];
        for (let j = 0; j < params.density; j += 1) {
          const size = params.size * (0.55 + Math.random() * 0.7);
          puffs.push({
            x: rand(-200, width + 200),
            y: rand(-100, height + 100),
            radius: size * (1 + i * 0.18),
            wobble: rand(0.6, 1.4),
          });
        }

        layers.push({
          puffs,
          blur: params.blur + i * 12,
          alpha: 0.5 - i * 0.08,
          color: baseColors[i % baseColors.length],
          depth: 0.6 + i * 0.35,
        });
      }
    }

    function drawLight(targetCtx, width, height) {
      const lightStrength = params.light / 100;
      const gradient = targetCtx.createLinearGradient(0, 0, width, height);
      gradient.addColorStop(0, `rgba(180, 205, 240, ${0.2 * lightStrength})`);
      gradient.addColorStop(0.6, `rgba(120, 160, 210, ${0.12 * lightStrength})`);
      gradient.addColorStop(1, `rgba(40, 80, 130, ${0.18 * lightStrength})`);
      targetCtx.fillStyle = gradient;
      targetCtx.fillRect(0, 0, width, height);
    }

    function drawPuff(targetCtx, puff, time, layer) {
      const noiseScale = 0.0006 * layer.depth;
      const nx = puff.x;
      const ny = puff.y;

      const n = valueNoise(nx * noiseScale, ny * noiseScale);
      const wobble = Math.sin(time * puff.wobble + n * Math.PI * 2) * 12;
      const x = puff.x + n * 80 * layer.depth + wobble;
      const y = puff.y + n * 50 * layer.depth + wobble * 0.4;

      const radius = puff.radius + n * 40;
      const gradient = targetCtx.createRadialGradient(x, y, radius * 0.2, x, y, radius);
      gradient.addColorStop(0, "rgba(255, 255, 255, 0.95)");
      gradient.addColorStop(0.5, layer.color);
      gradient.addColorStop(1, "rgba(90, 120, 160, 0.02)");
      targetCtx.fillStyle = gradient;
      targetCtx.beginPath();
      targetCtx.arc(x, y, radius, 0, Math.PI * 2);
      targetCtx.fill();
    }

    function renderScene(targetCtx, width, height) {
      const t = 0.2;

      targetCtx.clearRect(0, 0, width, height);
      drawBackdrop(targetCtx, width, height);
      drawLight(targetCtx, width, height);

      layers.forEach((layer, layerIndex) => {
        targetCtx.save();
        targetCtx.globalAlpha = layer.alpha;
        targetCtx.filter = `blur(${layer.blur}px)`;
        targetCtx.globalCompositeOperation = layerIndex === 0 ? "screen" : "lighter";

        layer.puffs.forEach((puff) => {
          drawPuff(targetCtx, puff, t, layer);
        });

        targetCtx.restore();
      });
    }

    function updateLabels() {
      valueLabels.forEach((label) => {
        const key = label.dataset.value;
        if (key === "background" || key === "blurrydotsColor") {
          label.textContent = params[key].toUpperCase();
          return;
        }
        if (key === "light") {
          label.textContent = `${params[key]}%`;
          return;
        }
        if (key === "exportWidth" || key === "exportHeight") {
          label.textContent = params[key];
          return;
        }
        label.textContent = params[key];
      });
    }

    function applySettings({ reseed = false } = {}) {
      if (reseed) {
        noiseSeed = Math.random() * 1000;
      }
      params.background = inputs.background.value;
      params.blurrydotsColor = inputs.blurrydotsColor.value;
      params.exportWidth = Number(inputs.exportWidth.value);
      params.exportHeight = Number(inputs.exportHeight.value);
      params.density = Number(inputs.density.value);
      params.layers = Number(inputs.layers.value);
      params.size = Number(inputs.size.value);
      params.blur = Number(inputs.blur.value);
      params.light = Number(inputs.light.value);
      updateLabels();
      initLayers(canvas.width / dpr, canvas.height / dpr);
      renderScene(ctx, canvas.width / dpr, canvas.height / dpr);
    }

    Object.values(inputs).forEach((input) => {
      input.addEventListener("input", () => applySettings());
    });

    document.getElementById("randomize").addEventListener("click", () => {
      applySettings({ reseed: true });
    });

    document.getElementById("download").addEventListener("click", () => {
      const exportCanvas = document.createElement("canvas");
      exportCanvas.width = Math.max(320, params.exportWidth);
      exportCanvas.height = Math.max(320, params.exportHeight);
      const exportCtx = exportCanvas.getContext("2d");

      initLayers(exportCanvas.width, exportCanvas.height);
      renderScene(exportCtx, exportCanvas.width, exportCanvas.height);

      const link = document.createElement("a");
      const rand = Math.floor(1000 + Math.random() * 9000);
      const seedLabel = Math.floor(noiseSeed);
      link.download = `blurrydots_${seedLabel}_${rand}.png`;
      link.href = exportCanvas.toDataURL("image/png");
      link.click();

      initLayers(canvas.width / dpr, canvas.height / dpr);
      renderScene(ctx, canvas.width / dpr, canvas.height / dpr);
    });

    window.addEventListener("resize", () => {
      resize();
      applySettings();
    });

    resize();
    applySettings();
  </script>
</body>
</html>
